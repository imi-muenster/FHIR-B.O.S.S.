# Fhir Facade

This is a first version of a facade implemented with HAPI FHIR that sits in front of a BaseX Server to perform all Operations following the FHIR standard, but also allow powerful queries performed with XQuery. 

## Setup 

To start the Facade create a `default.properties` file within a folder `settings` in the root of the project. The file has to contain the following information: 
```
basex.host=""
basex.port=
basex.username=""
basex.password=""
```
Build the project to create a .war file. Deploy the file on a Tomcat server.

Adjust the server.xml configuration to allow certain query characters.

Change 
```xml
<Connector port="8080" protocol="HTTP/1.1" connectionTimeout="20000" redirectPort="8443" />
```
to 
```xml
<Connector port="8080" protocol="HTTP/1.1" connectionTimeout="20000" redirectPort="8443" relaxedQueryChars='^{}[]|&quot;' />
```

The Server will be accessible from the URL `http://[base]/fhir/...`.

## Setup test server
To setup a test server one can easily use a local BaseX docker container. Look [here](https://docs.basex.org/wiki/Docker) how to set it up correctly.
After that adjust the `default.properties` file and start the FHIR facade locally. Download the example FHIR resources from the [official](https://hl7.org/fhir/downloads.html) website.
Put them into `src/main/resources/fhirResources/example-json` and run the main method of `ExampleResources` in `src/main/kotlin/utils` to add all of them to the BaseX database.

## REST
FhirFacade is carefully modeled to conform to the [FHIR RESTful API](http://hl7.org/fhir/http.html) and the [FHIR Search](http://hl7.org/fhir/search.html) specifications.
To understand how this facade operates read those specifications throughout.

## Class Generator
The ResourceProviders are generated by HAPI-FHIRs [hapi-tinder-plugin](https://github.com/hapifhir/hapi-fhir/tree/master/hapi-tinder-plugin) with a customized velocity template. 
That way this facade will be easily adjustable to changes to the FHIR standard and allows creating different versions for different FHIR versions (DSTU2, DSTU3, R4, R5). 
The template generator uses the information from the official Resource Java classes.
ResourceProviders will be automatically created during build phase and are located under `${projectRoot}/build/generated-sources`.
To adjust which FHIR versions should be used, change the configuration in the build.gradle.kts.
```kotlin
val config = listOf(
    VersionSetting("dstu2", false),
    VersionSetting("dstu3", false),
    VersionSetting("r4", true),
    VersionSetting("r5", true)
)
```
In its current state the FhirFacade is build to support R4 specifically.

## How does it work?

### Query Generator